<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.9/css/all.css" integrity="sha384-5SOiIsAziJl6AWe0HWRKTXlfcSHKmYV4RBF18PPJ173Kzn7jzMyFuTtk8JA7QQG1" crossorigin="anonymous">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="financeAid.css">
    <title>Transfer</title>
  </head>
  <body>
    <div class="d-flex">
      <nav class="sidebar bg-dark" id="sidebar">
        <ul class="list-unstyled">
          <li><a class="navbar-brand text-center" href="financeAid.html">Finance Aid</a></li>
          <li>
            <a href="income.html" class="text-center d-block">
                <i class="fa fa-plus nav-item float-left"></i>
                <div class="text">
                  <span class="d-none d-lg-block">Income</span>
                  <span class="d-none d-lg-block" id="totalIncome">RM0.00</span>
                </div>
            </a>
          </li>
          <li>
            <a href="expense.html" class="text-center d-block">
              <i class="fa fa-minus nav-item float-left"></i>
              <span class="d-none d-lg-block">Expense</span>
              <span class="d-none d-lg-block" id="totalExpense">RM0.00</span>                   
            </a>
          </li>
          <li>
            <a href="#" class="text-center d-block">
              <i class="fa fa-exchange-alt nav-item float-left middleicon"></i>
              <span class="d-none d-lg-inline align-middle">Transfer</span>
            </a>
          </li>
          <hr style="background-color: white;">
          <li>
            <a href="settings.html" class="text-center d-block">
              <i class="fa fa-cog nav-item float-left middleicon"></i>
              <span class="d-none d-lg-inline align-middle">Settings</span>
            </a>
          </li>
        </ul>
      </nav>
    
      <!-- Content in middle of web page --> 
      <div class="content p-4">
        <!--Button to toggle side bar-->
        <ul id="toggle-group" class="p-0">
          <li>
            <a class="sidebar-toggle btn text-light"><i class="fa fa-bars" style="color:white;"></i>Menu</a>
          </li>
          <li>
            <a class="sidebar-toggleright btn text-light float-right"><i class="fa fa-list-ul" style="color:white;"></i>Menu</a>
          </li>
        </ul>       
      
        <!-- Header -->
        <div class="container py-md-2 pt-md-4">
          <div class="row">
            <div class="col-md-12 text-center">
              <p style="font-size:3rem; color: green;">Transfer</p>
            </div>
          </div>
        </div>
        
        <!-- Canva for doughnut chart -->
        <div class="container chart py-md-2 pt-md-4">
          <div class="row">
            <div class="col-md-12 text-center chart">
              <canvas id="myChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      

      <!-- Content of right side bar -->
      <div class="sidebar-right" id="sidebar-right">
            <div class="summary text-center mt-4 mx-0">
              <div class="btn-group btn-group-toggle" data-toggle="buttons">
                <button class="btn btn-secondary active" id="sumByDate">
                  <input type="radio" name="options" id="option1" autocomplete="off" checked>
                    <i class="fa fa-calendar-alt"></i>
                    By date
                </button>
                <button class="btn btn-secondary" id="sumByCat">
                  <input type="radio" name="options" id="option2" autocomplete="off">
                    <i class="fa fa-tag"></i>
                    By category
                </button>
              </div>
            </div>
    
            <ul class="list-group" id="transferList">
              <!--Insert from database-->                           
            </ul>
      </div>

          
      <!--Button for adding records-->
      <button class="btn bg-dark mt-2" type="button" data-toggle="modal" data-target="#addRecord" id="addRecordBtn">
        <i class="fa fa-plus p-3" style="color: white; font-size: 50px;"></i>
      </button>
  
      <!-- Modal for adding records -->
      <div class="modal fade" id="addRecord" tabindex="-1" role="dialog" aria-labelledby="addRecord" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <select class="custom-select" id="selectFeature">
                <option value="exp">Add Expense</option>
                <option value="inc">Add Income</option>
                <option value="trf" selected="selected">Add Transfer</option>
              </select>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeBtn">
                <span aria-hidden="true">&#10005;</span>
              </button>
            </div>
            <div class="modal-body" id="modal-body">
              <div id="amount-group">
                <label for="amount">Amount</label>
                <div class="input-group mb-3">
                  <input onkeyup="checkFormsValidity();" type="text" class="form-control" id="amount" placeholder="Amount" aria-label="amount" aria-describedby="amount" required="required">
                  <div class="input-group-append">
                    <span class="input-group-text">RM</span>
                  </div>
                </div>
              </div>
              <div id="account-group" style="display: none;">
                <label for="account">Account</label>
                <div class="input-group mb-3">
                  <select name="" id="account">
                    <option value="">Choose an option:</option>
                    <option value="Bank">Bank</option>
                    <option value="Cash">Cash</option>
                  </select>
                </div>
              </div>
              <div id="category-group" style="display: none;">
                <label for="category">Category</label>
                <div class="input-group mb-3">
                  <select name="" id="category">
                    <option value="">Choose an option:</option>
                    <option value="Foods and Drinks">Foods and Drinks</option>
                    <option value="Vehicle">Vehicle</option>
                    <option value="Entertainment">Entertainment</option>                                
                  </select>
                </div>
              </div>                
              <div id="trfFrom-group">
                <label for="transferFrom">Transfer From</label>
                <div class="input-group mb-3">
                  <select name="" id="transferFrom">
                    <option value="" selected="selected">Choose an option:</option>
                    <option value="Bank">Bank</option>
                    <option value="Cash">Cash</option>
                  </select>
                </div>
              </div>
              <div id="trfTo-group">
                <label for="transferTo">Transfer To</label>
                <div class="input-group mb-3">
                  <input class="form-control" id="transferTo" readonly>
                </div>                  
              </div>
              <div id="date-group">
                <label for="date">Date</label>
                <div class="input-group mb-3">
                  <input type="text" class="datepicker" id="datepicker"></p>
                </div>
              </div>
              <button type="button" data-dismiss="modal" class="btn btn-secondary btn-lg btn-block" id="saveBtn">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
    <script src="financeAid.js"></script>
    <script>
      //Initialise Datepicker
      $('.datepicker').datepicker({ maxDate: new Date() }).datepicker("setDate", new Date());
            
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyAR3t7qI2D5wRu4fO38FuPYbPegZwQd_yI",
        authDomain: "finance-aid-b7793.firebaseapp.com",
        databaseURL: "https://finance-aid-b7793.firebaseio.com",
        projectId: "finance-aid-b7793",
        storageBucket: "finance-aid-b7793.appspot.com",
        messagingSenderId: "165519709635"
      };
      firebase.initializeApp(config);

      //output list of data when loading the page and only appear if there are available data
      var transferRef = firebase.database().ref('transferObj').orderByChild('transferDate');
      var transferObj;
      transferRef.on("value", function(snapshot) {
        snapshot.forEach(function(childSnapshot){
          transferObj = childSnapshot.val();
          var trfDate = transferObj.transferDate;
          var trfFrom = transferObj.transferFrom;
          var trfTo = transferObj.transferTo;
          var trfAmt = parseFloat(transferObj.transferAmount);
          $('#transferList').append(
          '<li class="list-group-item nopadding">' + 
            '<div class="card">' + 
              '<div class="card-header">' + trfDate + '</div>' + 
              '<div class="card-body">' +
                '<div class="card-text">' + 
                  '<p>' + trfFrom + '</p>' + 
                  '<p>' + trfTo + '</p>' + 
                  '<p>' + "RM" + trfAmt.toFixed(2) + '</p>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</li>');
        });
      });

      //display transfer records with filter
      $('#sumByDate').click(function(){
        $('#transferList li').remove();
        var transferRef = firebase.database().ref('transferObj').orderByChild('transferDate');
        var transferObj;
        transferRef.on("value", function(snapshot) {
          snapshot.forEach(function(childSnapshot){
            transferObj = childSnapshot.val();
            var trfDate = transferObj.transferDate;
            var trfFrom = transferObj.transferFrom;
            var trfTo = transferObj.transferTo;
            var trfAmt = parseFloat(transferObj.transferAmount);
            $('#transferList').append(
              '<li class="list-group-item nopadding">' + 
              '<div class="card">' + 
                '<div class="card-header">' + trfDate + '</div>' + 
                '<div class="card-body">' +
                  '<div class="card-text">' + 
                    '<p>' + trfFrom + '</p>' + 
                    '<p>' + trfTo + '</p>' + 
                    '<p>' + "RM" + trfAmt.toFixed(2) + '</p>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</li>');
          });
        });
      });

      $('#sumByCat').click(function(){
        $('#transferList li').remove();
        var transferRef = firebase.database().ref('transferCat/Bank').orderByChild('transferDate');
        var transferObj;
        transferRef.on("value", function(snapshot) {
          snapshot.forEach(function(childSnapshot){
            transferObj = childSnapshot.val();
            var trfDate = transferObj.transferDate;
            var trfFrom = transferObj.transferFrom;
            var trfTo = transferObj.transferTo;
            var trfAmt = parseFloat(transferObj.transferAmount);
            $('#transferList').append(
            '<li class="list-group-item nopadding">' + 
              '<div class="card">' + 
                '<div class="card-header">' + trfFrom + " &#8594; " + trfTo + '</div>' + 
                '<div class="card-body">' +
                  '<div class="card-text">' + 
                    '<p>' + trfDate + '</p>' + 
                    '<p>' + "RM" + trfAmt.toFixed(2) + '</p>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</li>');
          });
        });
        var transferRef = firebase.database().ref('transferCat/Cash').orderByChild('transferDate');
        var transferObj;
        transferRef.on("value", function(snapshot) {
          snapshot.forEach(function(childSnapshot){
            transferObj = childSnapshot.val();
            var trfDate = transferObj.transferDate;
            var trfFrom = transferObj.transferFrom;
            var trfTo = transferObj.transferTo;
            var trfAmt = parseFloat(transferObj.transferAmount);
            $('#transferList').append(
            '<li class="list-group-item nopadding">' + 
              '<div class="card">' + 
                '<div class="card-header">' + trfFrom + " &#8594; " + trfTo + '</div>' + 
                '<div class="card-body">' +
                  '<div class="card-text">' + 
                    '<p>' + trfDate + '</p>' + 
                    '<p>' + "RM" + trfAmt.toFixed(2) + '</p>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</li>');
          });
        });
      });
      
      // Disable function
      jQuery.fn.extend({
        disable: function(state) {
          return this.each(function() {
            this.disabled = state;
          });
        }
      });
      
      //change disabled state if the input area are filled
      var saveButton = document.getElementById('saveBtn');
      saveButton.disabled = true;
      
      function checkFormsValidity(){
        var amountInput = document.getElementById('amount');
        if (amountInput.checkValidity()) {
          saveButton.disabled = false;
        } else {
          saveButton.disabled = true;
        }
      }
      
      //only enable number and decimal points to be input
      $('#amount').keypress(function(e) {
        var a = [];
        var k = e.which;
      
        var y = 46;
        a.push(y);
      
        for (i = 48; i < 58; i++)
          a.push(i);
          
        if (!(a.indexOf(k)>=0))
          e.preventDefault();    
      });
      
      //auto set transfer account when user selected
      var selectedAccount = $("#transferFrom option:selected");
      $('#transferFrom').change(function(){
        selectedAccount.each(function() {
          if (document.getElementById("transferFrom").value == "Bank"){
            document.getElementById("transferTo").value = "Cash";
          } else if (document.getElementById("transferFrom").value == "Cash"){
            document.getElementById("transferTo").value = "Bank";
          } else {
            document.getElementById("transferTo").value = "";
          }
        });
      });
      
      //switch modal body view by selection
      $("#selectFeature").change(function(){
        var selectedFeature = this.value;        
        if (selectedFeature == "inc") {
          $("#account-group").show(500);
          $("#category-group").hide(500);
          $("#trfFrom-group").hide(500);          
          $("#trfTo-group").hide(500);
        } else
        if (selectedFeature == "trf") {
          $("#account-group").hide(500);
          $("#category-group").hide(500);
          $("#trfFrom-group").show(500);          
          $("#trfTo-group").show(500);
        } else
        if (selectedFeature == "exp") {
          $("#account-group").show(500);
          $("#category-group").show(500);
          $("#trfFrom-group").hide(500);          
          $("#trfTo-group").hide(500);
        }
      });
      
      //Read the total amount of income from database
      var totalIncomeRef = firebase.database().ref('incomeObj');
      var totalIncomeObj;
      var totalIncome = 0;
      totalIncomeRef.on('value', function(snapshot){
        snapshot.forEach(function(childSnapshot){
          totalIncomeObj = childSnapshot.val();
          var incAmt = parseFloat(totalIncomeObj.incomeAmount);
          totalIncome += incAmt;
        });
        document.getElementById("totalIncome").innerHTML = "RM" + totalIncome.toFixed(2);
      });

      //Read the total amount of expense from database
      var totalExpenseRef = firebase.database().ref('expenseObj');
      var totalExpenseObj;
      var totalExpense = 0;
      totalExpenseRef.on('value', function(snapshot){
        snapshot.forEach(function(childSnapshot){
          totalExpenseObj = childSnapshot.val();
          var expAmt = parseFloat(totalExpenseObj.expenseAmount);
          totalExpense += expAmt;
        });
        document.getElementById("totalExpense").innerHTML = "RM" + totalExpense.toFixed(2);
      });

      //fetch current amount for both account
      var currentCashObj = {};
      var currentCashAmtRef = firebase.database().ref('currentCashAmt');
      currentCashAmtRef.on('value', function(snapshot){
        var childData = snapshot.val();
        currentCashObj.currentCash = parseFloat(childData.currentCash);
      });
    
      var currentBankObj = {};
      var currentBankAmtRef = firebase.database().ref('currentBankAmt');
      currentBankAmtRef.on('value', function(snapshot){
        var childData = snapshot.val();
        currentBankObj.currentBank = parseFloat(childData.currentBank);
      });
            
      //trigger when click on save button
      $("#saveBtn").click(function() {
        var validFeature = document.getElementById("selectFeature");
        var currentSelectedFeature = validFeature.options[validFeature.selectedIndex].value;
              
        if (currentSelectedFeature == "exp") {
          var expenseDateObj = $("#datepicker").datepicker("getDate");
          //return in MM-DD-YYYY
          var expDate = $.datepicker.formatDate("mm-dd-yy", expenseDateObj);
          var expAcc = document.getElementById("account").value;
          var expCat = document.getElementById("category").value;
          var expAmt = document.getElementById("amount").value;
      
          if (expAcc != "" && expCat != "") {
            //write records into list to firebase db
            var expenseObj = {};
            var expenseObjKey = expenseObjKey ? expenseObjKey : firebase.database().ref().child('expenseObj').push().key;
            expenseObj[expenseObjKey] = {expenseDate: expDate, expenseAccount: expAcc, expenseCategory: expCat, expenseAmount: expAmt};
            firebase.database().ref('expenseCat').child(expCat).update(expenseObj);

            //calculate and update current amount based on expense
            var selectedAccount = expAcc;
            var currentexpenseAmt = parseFloat(expenseObj[expenseObjKey].expenseAmount);
            if (selectedAccount == "Bank") {
              var currentBankAmt = parseFloat(currentBankObj.currentBank);
              var validExpDiff = currentBankAmt - currentexpenseAmt;
              if (validExpDiff < 0) {
                alert("Your current account does not have sufficient money");
                $('.datepicker').datepicker("setDate", new Date());
                document.getElementById("account").value = '';
                document.getElementById("category").value = '';
                document.getElementById("amount").value = '';
              } else {
                firebase.database().ref().child('expenseObj').update(expenseObj);
                currentBankAmt -= currentexpenseAmt;
                                  
                //upload the current amount to firebase db
                currentBankObj.currentBank = currentBankAmt;
                firebase.database().ref().child('currentBankAmt').update(currentBankObj);
      
                //clear the input form after success alert
                alert("Your expense added successfully!");
                $('.datepicker').datepicker("setDate", new Date());
                document.getElementById("account").value = '';
                document.getElementById("category").value = '';
                document.getElementById("amount").value = '';
              }
            } else if (selectedAccount == "Cash") {
              var currentCashAmt = parseFloat(currentCashObj.currentCash);
              var validExpDiff = currentCashAmt - currentexpenseAmt;
              if (validExpDiff < 0) {
                alert("Your current account does not have sufficient money");
                $('.datepicker').datepicker("setDate", new Date());
                document.getElementById("account").value = '';
                document.getElementById("category").value = '';
                document.getElementById("amount").value = '';
              } else {
                firebase.database().ref().child('expenseObj').update(expenseObj);
                currentCashAmt -= currentexpenseAmt;
      
                //upload the current amount to firebase db
                currentCashObj.currentCash = currentCashAmt;
                firebase.database().ref().child('currentCashAmt').update(currentCashObj);
                              
                //clear the input form after success alert
                alert("Your expense added successfully!");
                $('.datepicker').datepicker("setDate", new Date());
                document.getElementById("account").value = '';
                document.getElementById("category").value = '';
                document.getElementById("amount").value = '';
              }                
            }
          } else {
            alert("Please ensure either Account or Category has been selected");
          }        
        } else if (currentSelectedFeature == "inc") {
          var incomeDateObj = $("#datepicker").datepicker("getDate");
          //return in MM-DD-YYYY
          var incDate = $.datepicker.formatDate("mm-dd-yy", incomeDateObj);
          var incAcc = document.getElementById("account").value;
          var incAmt = document.getElementById("amount").value;
      
          var validIncAmt = document.getElementById("amount").value;
          if (incAcc != ""){
            //write records into list to firebase db
            var incomeObj = {}; //(if without var, override on same object, never update)
            var incomeObjKey = incomeObjKey ? incomeObjKey : firebase.database().ref().child('incomeObj').push().key;
            incomeObj[incomeObjKey] = {incomeDate: incDate,incomeAccount: incAcc, incomeAmount: incAmt};            
            firebase.database().ref().child('incomeObj').update(incomeObj);
            firebase.database().ref('incomeAcc').child(incAcc).update(incomeObj);
                  
            //calculate and update current amount based on income
            var selectedAccount = document.getElementById('account').value;
            if (selectedAccount == "Bank"){
              var currentBankAmt = parseFloat(currentBankObj.currentBank);
              var currentIncomeAmt = parseFloat(incomeObj[incomeObjKey].incomeAmount);
              currentBankAmt += currentIncomeAmt;
                              
              //upload the current amount to firebase db
              currentBankObj.currentBank = currentBankAmt;
              firebase.database().ref().child('currentBankAmt').update(currentBankObj);
            } else if(selectedAccount == "Cash"){
              var currentCashAmt = parseFloat(currentCashObj.currentCash);
              var currentIncomeAmt = parseFloat(incomeObj[incomeObjKey].incomeAmount);
              currentCashAmt += currentIncomeAmt;
      
              //upload the current amount to firebase db
              currentCashObj.currentCash = currentCashAmt;
              firebase.database().ref().child('currentCashAmt').update(currentCashObj);
            }
      
            //clear the input form after success alert
            alert("Your income added successfully!");
            document.getElementById("account").value = '';
            document.getElementById("amount").value = '';
          }
        } else if (currentSelectedFeature == "trf") {
          var transferDateObj = $("#datepicker").datepicker("getDate");
          //return in MM-DD-YYYY
          var trfDate = $.datepicker.formatDate("mm-dd-yy", transferDateObj);
          var trfFrom = document.getElementById("transferFrom").value;
          var trfTo = document.getElementById("transferTo").value;
          var trfAmt = document.getElementById("amount").value;
      
          var validTrfAmt = document.getElementById("amount").value;
          if (trfFrom != "") {
            //write records into list to firebase db
            var transferObj = {}; //(override on same object, never update)
            var transferObjKey = transferObjKey ? transferObjKey : firebase.database().ref().child('transferObj').push().key;
            transferObj[transferObjKey] = {transferDate: trfDate, transferFrom: trfFrom, transferTo: trfTo, transferAmount: trfAmt};
            firebase.database().ref('transferCat').child(trfFrom).update(transferObj);
      
            //calculate and update current amount based on transfer
            var selectedAccountFrom = trfFrom;
            var currentTransferAmt = parseFloat(transferObj[transferObjKey].transferAmount);
            var currentBankAmt;
            var currentCashAmt;
            if (selectedAccountFrom == "Bank"){
              currentBankAmt = parseFloat(currentBankObj.currentBank);
              currentCashAmt = parseFloat(currentCashObj.currentCash);
              var validTrfDiff = currentBankAmt - currentTransferAmt;
                              
              if (validTrfDiff < 0) {
                alert("Your Bank account does not have sufficient money");
                document.getElementById("transferFrom").value = '';
                document.getElementById("transferTo").value = '';
                document.getElementById("amount").value = '';
              } else {
                firebase.database().ref().child('transferObj').update(transferObj);
                currentBankAmt -= currentTransferAmt;
                currentCashAmt += currentTransferAmt;
      
                //upload the current amount to firebase db
                currentBankObj.currentBank = currentBankAmt;
                currentCashObj.currentCash = currentCashAmt;
                firebase.database().ref().child('currentBankAmt').update(currentBankObj);
                firebase.database().ref().child('currentCashAmt').update(currentCashObj);
      
                //clear the input form after success alert
                alert("Your transfer added successfully!");
                document.getElementById("transferFrom").value = '';
                document.getElementById("transferTo").value = '';
                document.getElementById("amount").value = '';

                //update the list with latest data
                $('#transferList li').remove();
                var transferRef = firebase.database().ref('transferObj').orderByChild('transferDate');
                var transferObj;
                transferRef.on("value", function(snapshot) {
                  snapshot.forEach(function(childSnapshot){
                    transferObj = childSnapshot.val();
                    var trfDate = transferObj.transferDate;
                    var trfFrom = transferObj.transferFrom;
                    var trfTo = transferObj.transferTo;
                    var trfAmt = parseFloat(transferObj.transferAmount);
                    $('#transferList').append(
                    '<li class="list-group-item nopadding">' + 
                      '<div class="card">' + 
                        '<div class="card-header">' + trfDate + '</div>' + 
                        '<div class="card-body">' +
                          '<div class="card-text">' + 
                            '<p>' + trfFrom + '</p>' + 
                            '<p>' + trfTo + '</p>' + 
                            '<p>' + "RM" + trfAmt.toFixed(2) + '</p>' +
                          '</div>' +
                        '</div>' +
                      '</div>' +
                    '</li>');
                  });
                });
              }                        
            } else if(selectedAccountFrom == "Cash"){
              currentBankAmt = parseFloat(currentBankObj.currentBank);
              currentCashAmt = parseFloat(currentCashObj.currentCash);
              var validTrfDiff = currentCashAmt - currentTransferAmt;
                              
              if (validTrfDiff < 0) {
                alert("Your Cash account does not have sufficient money");
                document.getElementById("transferFrom").value = '';
                document.getElementById("transferTo").value = '';
                document.getElementById("amount").value = '';
              } else {
                firebase.database().ref().child('transferObj').update(transferObj);
                currentBankAmt += currentTransferAmt;
                currentCashAmt -= currentTransferAmt;

                //upload the current amount to firebase db
                currentBankObj.currentBank = currentBankAmt;
                currentCashObj.currentCash = currentCashAmt;
                firebase.database().ref().child('currentBankAmt').update(currentBankObj);
                firebase.database().ref().child('currentCashAmt').update(currentCashObj);
    
                //clear the input form after success alert
                alert("Your transfer added successfully!");
                document.getElementById("transferFrom").value = '';
                document.getElementById("transferTo").value = '';
                document.getElementById("amount").value = '';

                //update the list with latest data
                $('#transferList li').remove();
                var transferRef = firebase.database().ref('transferObj').orderByChild('transferDate');
                var transferObj;
                transferRef.on("value", function(snapshot) {
                  snapshot.forEach(function(childSnapshot){
                    transferObj = childSnapshot.val();
                    var trfDate = transferObj.transferDate;
                    var trfFrom = transferObj.transferFrom;
                    var trfTo = transferObj.transferTo;
                    var trfAmt = parseFloat(transferObj.transferAmount);
                    $('#transferList').append(
                    '<li class="list-group-item nopadding">' + 
                      '<div class="card">' + 
                        '<div class="card-header">' + trfDate + '</div>' + 
                        '<div class="card-body">' +
                          '<div class="card-text">' + 
                            '<p>' + trfFrom + '</p>' + 
                            '<p>' + trfTo + '</p>' + 
                            '<p>' + "RM" + trfAmt.toFixed(2) + '</p>' +
                          '</div>' +
                        '</div>' +
                      '</div>' +
                    '</li>');
                  });
                });
              }
            }
          }
        }
      
        //reset list for records
        $("#sumByDate").addClass('active');
        $("#sumByCat").removeClass('active');

        //reset modal dialog input area
        $("#selectFeature").prop('selectedIndex', 2);
        document.getElementById("amount").value = '';
        document.getElementById("account").value = '';
        document.getElementById("category").value = '';
        document.getElementById("transferFrom").value = '';
        $("#account-group").hide(1000);
        $("#category-group").hide(1000);
        $("#trfFrom-group").show(1000);          
        $("#trfTo-group").show(1000);

        //update total amount for each type of transfer and assign to chart
        var bTcTotal = 0;
        var cTbTotal = 0;
        function delay() {
          var totalAmt = [];
          // `delay` returns a promise
          return new Promise(function(resolve, reject) {
            // Only `delay` is able to resolve or reject the promise
            var bTcRef = firebase.database().ref('transferCat/Bank').orderByChild('transferDate');
            var bTcObj;
            bTcRef.once("value", function(snapshot) {
              snapshot.forEach(function(childSnapshot){
                bTcObj = childSnapshot.val();
                var bTcAmt = parseFloat(bTcObj.transferAmount);
                bTcTotal += bTcAmt;
              });
              totalAmt.push(bTcTotal);
            });
            var cTbRef = firebase.database().ref('transferCat/Cash').orderByChild('transferDate');
            var cTbObj;
            cTbRef.once("value", function(snapshot) {
              snapshot.forEach(function(childSnapshot){
                cTbObj = childSnapshot.val();
                var cTbAmt = parseFloat(cTbObj.transferAmount);
                cTbTotal += cTbAmt;
              });
              totalAmt.push(cTbTotal);
              resolve(totalAmt);
            });
          });
        }

        delay()
          .then(function(v) { // `delay` returns a promise, 'v' is an array contain both bankToCashTotal and cashToBankTotal
            //integrate chart.js
            var ctx = $("#myChart");
            var myChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ["Bank to Cash", "Cash to Bank"],
                datasets: [{
                  label: '# of Votes',
                  data: [bTcTotal, cTbTotal],
                  backgroundColor: [
                      'rgba(0, 0, 139, 0.2)',
                      'rgba(178, 34, 34, 0.2)'
                  ],
                  borderColor: [
                    'rgba(0, 0, 139, 1)',
                    'rgba(178, 34, 34, 1)'
                  ],
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  xAxes: [{
                    ticks: {
                      display: false,
                    },
                    gridLines: {
                      display: false,
                      drawBorder: false,
                    }
                  }],
                  yAxes: [{
                    ticks: {
                      display: false,
                    },
                    gridLines: {
                      display: false,
                      drawBorder: false,
                    }
                  }]
                }
              }
            }); 
          })
          .catch(function(v) {
            alert("Chart will not display if income of Bank or Account empty");
          });
      });

      //read total amount for each type of transfer and assign to chart
      var bTcTotal = 0;
      var cTbTotal = 0;
      function delay() {
        var totalAmt = [];
        // `delay` returns a promise
        return new Promise(function(resolve, reject) {
          // Only `delay` is able to resolve or reject the promise
          var bTcRef = firebase.database().ref('transferCat/Bank').orderByChild('transferDate');
          var bTcObj;
          bTcRef.once("value", function(snapshot) {
            snapshot.forEach(function(childSnapshot){
              bTcObj = childSnapshot.val();
              var bTcAmt = parseFloat(bTcObj.transferAmount);
              bTcTotal += bTcAmt;
            });
            totalAmt.push(bTcTotal);
          });
          var cTbRef = firebase.database().ref('transferCat/Cash').orderByChild('transferDate');
          var cTbObj;
          cTbRef.once("value", function(snapshot) {
            snapshot.forEach(function(childSnapshot){
              cTbObj = childSnapshot.val();
              var cTbAmt = parseFloat(cTbObj.transferAmount);
              cTbTotal += cTbAmt;
            });
            totalAmt.push(cTbTotal);
            resolve(totalAmt);
          });
        });
      }

      delay()
        .then(function(v) { // `delay` returns a promise, 'v' is an array contain both bankToCashTotal and cashToBankTotal
          //integrate chart.js
          var ctx = $("#myChart");
          var myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ["Bank to Cash", "Cash to Bank"],
              datasets: [{
                label: '# of Votes',
                data: [bTcTotal, cTbTotal],
                backgroundColor: [
                    'rgba(0, 0, 139, 0.2)',
                    'rgba(178, 34, 34, 0.2)'
                ],
                borderColor: [
                  'rgba(0, 0, 139, 1)',
                  'rgba(178, 34, 34, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                xAxes: [{
                  ticks: {
                    display: false,
                  },
                  gridLines: {
                    display: false,
                    drawBorder: false,
                  }
                }],
                yAxes: [{
                  ticks: {
                    display: false,
                  },
                  gridLines: {
                    display: false,
                    drawBorder: false,
                  }
                }]
              }
            }
          });
        })
        .catch(function(v) {
          alert("Chart will not display if income of Bank or Account empty");
        });

    </script>
  </body>
</html>